#!/bin/bash

function remove_charts
{
	helm del --purge exploitable-ingress
	helm del --purge db
	helm del --purge redis
	helm del --purge exploitableapp-ws
	helm del --purge exploitableapp
	helm del --purge elastic
	helm del --purge elastic-patch
	helm del --purge guac
	#helm del --purge gitlab
	kubectl delete all -l release=elastic --namespace logs
	kubectl delete pvc -l release=elastic --namespace logs
	kubectl delete secrets -l release=elastic --namespace logs
	#kubectl delete all -l release=gitlab --namespace gitlab
	#kubectl delete pvc -l release=gitlab --namespace gitlab
	#kubectl delete secrets -l release=gitlab --namespace gitlab
}

domain='attlocal.net'

####################################################
#Remove Old Charts
####################################################
remove_charts

####################################################
#Add Charts
####################################################

#Guacamole
helm install --namespace exploitable --name guac ./charts/guacamole/ --set hostName=$(echo "guacamole.$domain")

#Exploitable App
helm install stable/nginx-ingress --namespace exploitable --name exploitable-ingress --set rbac.create=true
helm install --namespace exploitable --name db ./charts/db/
helm install --namespace exploitable --name redis ./charts/redis/
helm install --namespace exploitable --name exploitableapp-ws ./charts/exploitableappwebservice/
helm install --namespace exploitable --name exploitableapp ./charts/exploitableapp/ --set ingress.hosts={$(echo "exploitable.$domain")}

#Elastic Stack
#helm install --name elastic --namespace logs stable/elastic-stack \
#  --set fluent-bit.enabled=true \
#  --set fluent-bit.backend.forward.port=24220 \
#  --set fluent-bit.backend.forward.host=elastic-fluentd \
#  --set fluent-bit.backend.es.host=elastic-elasticsearch-client \
#  --set fluentd.enabled=true \
#  --set fluentd-elasticsearch.enabled=true \
#  --set fluentd-elasticsearch.elasticsearch.host='elastic-elasticsearch-client'
#kubectl patch configmap/elastic-kibana --namespace logs --type merge -p '"data": { "kibana.yml": "elasticsearch.url: http://elastic-elasticsearch-client:9200\nserver.host: \"0\"\nserver.name: elastic-kibana\n" }'
#helm install --name elastic-patch --namespace logs ./charts/elastic/

#Gitlab
#helm repo add gitlab https://charts.gitlab.io/
#helm repo update
#helm upgrade --install gitlab gitlab/gitlab --namespace gitlab --timeout 600 \
#  --set global.edition=ce \
#  --set global.hosts.domain=$domain \
#  --set certmanager-issuer.email=me@exploitable.app
#kubectl get secret gitlab-gitlab-initial-root-password -ojsonpath='{.data.password}' --namespace gitlab | base64 --decode ; echo

####################################################
#Watch Pods
####################################################
watch kubectl get all --namespace exploitable

####################################################
#Remove Charts
####################################################
remove_charts
