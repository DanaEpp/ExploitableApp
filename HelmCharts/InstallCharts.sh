#!/bin/bash

uuid=$(cat /dev/urandom | env LC_CTYPE=C tr -dc 'a-z' | fold -w 6 | head -n 1)

function install_jq_if_needed
{
    if hash jq 2>/dev/null; then
        echo 2>/dev/null
    else
        if hash yum 2>/dev/null; then
			sudo yum install -y epel-release
            sudo yum install -y jq
        else
            if hash apt 2>/dev/null; then
                sudo apt update
                sudo apt install -y jq
            else
                echo "yum & apt is missing"
            fi    
        fi
    fi
}

function remove_charts
{
    #kubectl delete -f https://github.com/jetstack/cert-manager/releases/download/v0.8.1/cert-manager.yaml
	#kubectl delete -f cluster-issuer.yaml --namespace exploitable
	
	helm list --namespace exploitable --output json | jq '.Releases[].Name' | tr -d '"' | while read x; do helm del --purge $x; done
	#kubectl delete all --all --namespace exploitable
	#kubectl delete secrets --all --namespace exploitable

	#helm del --purge gitlab
	#kubectl delete all -l release=elastic --namespace logs
	#kubectl delete pvc -l release=elastic --namespace logs
	#kubectl delete secrets -l release=elastic --namespace logs
	#kubectl delete all -l release=gitlab --namespace gitlab
	#kubectl delete pvc -l release=gitlab --namespace gitlab
	#kubectl delete secrets -l release=gitlab --namespace gitlab
	#while true; do if echo "$(kubectl get pods --all-namespaces | grep 'Terminating')" | grep -q "Terminating"; then echo "Waiting on pods to Terminate (10s)"; sleep 10s; else break; fi; done
}

####################################################
#Check Params
####################################################
if [ "$#" -ne 1 ]; then
	#domain='attlocal.net'
	echo "You must provide a base domain:"
	echo "EXAMPLE 1: attlocal.net"
	echo "EXAMPLE 2: local"
	echo "EXAMPLE 3: exploitable.app"
	exit
else
	domain=$(echo "$uuid.$1")
fi

####################################################
#If we need to install jq do that now
####################################################
install_jq_if_needed

####################################################
#Helm Init
####################################################
if echo "$(kubectl get po --all-namespaces | grep tiller)" | grep -q tiller; then 
	echo "Tiller is Running"
else
	echo "Installing Tiller"
	kubectl apply -f https://gist.githubusercontent.com/postworthy/83b8dd925d7d79923af7d829b5985f16/raw/e55251c24ae92fd87356da66371600f6353e949d/tiller-rbac-config.yaml
    helm init --service-account tiller
	while true; do if echo "$(kubectl get pods -n kube-system | grep tiller | grep Running)" | grep -q "Running"; then break; else echo "Waiting on tiller (10s)"; sleep 10s; fi; done
fi;

####################################################
#Remove Old Charts
####################################################
#remove_charts

####################################################
#Add Charts
####################################################

#Cert Manager
#kubectl create namespace cert-manager
#kubectl label namespace cert-manager certmanager.k8s.io/disable-validation="true"
#kubectl apply -f https://github.com/jetstack/cert-manager/releases/download/v0.8.1/cert-manager.yaml
#while true; do if echo "$(kubectl get pods --all-namespaces | grep '0/1\|0/2')" | grep -q "0/1\|0/2"; then echo "Waiting on pods (10s)"; sleep 10s; else break; fi; done
#kubectl apply -f cluster-issuer.yaml --namespace exploitable

#Create exploitable namespace
kubectl create namespace exploitable

#Guacamole
helm install --namespace exploitable --name $(echo "guac-$uuid")  ./charts/guacamole/ --set hostName=$(echo "$domain")

#Exploitable App
helm install stable/nginx-ingress --namespace exploitable --name exploitable-ingress --set rbac.create=true
helm install --namespace exploitable --name $(echo "db-$uuid") ./charts/db/ --set fullnameOverride=$(echo "db-$uuid")
helm install --namespace exploitable --name $(echo "redis-$uuid") ./charts/redis/ --set fullnameOverride=$(echo "redis-$uuid")
helm install --namespace exploitable --name $(echo "exploitableapp-ws-$uuid") ./charts/exploitableappwebservice/ \
  --set fullnameOverride=$(echo "svc-$uuid") \
  --set dbServer=$(echo "db-$uuid") \
  --set redisServer=$(echo "redis-$uuid") \
  --set webServer=$(echo "web-$uuid") \
  --set webServiceServer=$(echo "svc-$uuid") \
  --set postgresHostName=$(echo "guac-$uuid-postgres")
helm install --namespace exploitable --name $(echo "exploitableapp-$uuid") ./charts/exploitableapp/ \
  --set ingress.hosts={$(echo "$domain")} \
  --set fullnameOverride=$(echo "web-$uuid") \
  --set dbServer=$(echo "db-$uuid") \
  --set redisServer=$(echo "redis-$uuid") \
  --set webServer=$(echo "web-$uuid") \
  --set webServiceServer=$(echo "svc-$uuid") \
  --set flag=$(echo "flag-$uuid") \
  --set ingress.azureapprouting=$(if echo "$domain" | grep -q "aksapp"; then echo "true"; else echo "false"; fi;)

#Elastic Stack
#helm install --name elastic --namespace logs stable/elastic-stack \
#  --set fluent-bit.enabled=true \
#  --set fluent-bit.backend.forward.port=24220 \
#  --set fluent-bit.backend.forward.host=elastic-fluentd \
#  --set fluent-bit.backend.es.host=elastic-elasticsearch-client \
#  --set fluentd.enabled=true \
#  --set fluentd-elasticsearch.enabled=true \
#  --set fluentd-elasticsearch.elasticsearch.host='elastic-elasticsearch-client'
#kubectl patch configmap/elastic-kibana --namespace logs --type merge -p '"data": { "kibana.yml": "elasticsearch.url: http://elastic-elasticsearch-client:9200\nserver.host: \"0\"\nserver.name: elastic-kibana\n" }'
#helm install --name elastic-patch --namespace logs ./charts/elastic/

#Gitlab
#helm repo add gitlab https://charts.gitlab.io/
#helm repo update
#helm upgrade --install gitlab gitlab/gitlab --namespace gitlab --timeout 600 \
#  --set global.edition=ce \
#  --set global.hosts.domain=$domain \
#  --set certmanager-issuer.email=me@exploitable.app
#kubectl get secret gitlab-gitlab-initial-root-password -ojsonpath='{.data.password}' --namespace gitlab | base64 --decode ; echo

####################################################
#Wait on Input
####################################################
echo "Press 'Enter' to Continue"
read

####################################################
#Watch Pods
####################################################
watch kubectl get all --namespace exploitable

####################################################
#Remove Charts
####################################################
#remove_charts


####################################################
#AKS Setup
####################################################
#az group create --name Temporary -l eastus
#az aks create --resource-group Temporary --name tempCluster --node-count 1 --node-vm-size Standard_B2s --kubernetes-version 1.13.5 --enable-addons http_application_routing --generate-ssh-keys
#az aks get-credentials --resource-group Temporary --name tempCluster
#kubectl create namespace cert-manager
#kubectl label namespace cert-manager certmanager.k8s.io/disable-validation="true"
#kubectl apply -f https://github.com/jetstack/cert-manager/releases/download/v0.8.1/cert-manager.yaml
#while true; do if echo "$(kubectl get pods --all-namespaces | grep '0/1\|0/2')" | grep -q "0/1\|0/2"; then echo "Waiting on pods (10s)"; sleep 10s; else break; fi; done
#kubectl create namespace exploitable
#kubectl apply -f cluster-issuer.yaml
#./InstallCharts.sh
