using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Identity.EntityFrameworkCore;
using Microsoft.EntityFrameworkCore;
using ExploitableApp.Models;
using Microsoft.AspNetCore.Identity;
using ExploitableApp.Controllers;
using System.IO;
using ExploitableApp.Services;
using ExploitableApp.Data;
using Microsoft.Extensions.Configuration;

namespace ExploitableApp.Managers
{
    public class ExCoinAccountManager
    {
        public IConfiguration Configuration
        {
            get;
            private set;
        }
        public ExCoinAccountManager(IConfiguration configuration)
        {
            Configuration = configuration;
        }

        private ApplicationDbContext GetContext()
        {
            //Configuration.GetConnectionString("DefaultConnection")
            var options = new DbContextOptionsBuilder<ApplicationDbContext>()
                .UseSqlServer(Configuration.GetConnectionString("DefaultConnection"))
                .EnableSensitiveDataLogging();
            return new ApplicationDbContext(options.Options);        
        }

        public ExCoinAccount CreateAccount(ApplicationUser user, float startingBalance = 0)
        {
            using (var context = GetContext())
            {
                var owner = context.Users.Find(user.Id);
                if (owner.Id != user.Id) throw new Exception("User Not Found while Creating Account!");
                var account = new ExCoinAccount
                {
                    AccountOwner = owner,
                    Balance = startingBalance
                };
                context.ExCoinAccounts.Add(account);
                context.SaveChanges();
                return account;
            }
        }

        public List<ExCoinAccount> GetAccounts(ApplicationUser user)
        {
            using (var context = GetContext())
            {
                return context.ExCoinAccounts
                              .Where(x => x.AccountOwner.Id == user.Id)
                              .AsNoTracking()
                              .ToList();
            }
        }

        public IQueryable<Transaction> GetTransactions(ExCoinAccount account)
        {
            var context = GetContext();
            return context.Transactions
                          .Where(x => x.To.ID == account.ID || x.From.ID == account.ID)
                          .AsNoTracking();
        }

        public List<Transaction> GetAccountTransactions(ExCoinAccount account, int skip = 0, int take = 25)
        {
            using (var context = GetContext())
            {
                return context.Transactions
                              .Where(x => x.To.ID == account.ID || x.From.ID == account.ID)
                              .Skip(skip)
                              .Take(take)
                              .AsNoTracking()
                              .ToList();
            }
        }

        public Transaction CreateTransaction(ExCoinAccount fromAccount, ExCoinAccount toAccount, float amount, string description, DateTime time)
        {
            using (var context = GetContext())
            {
                var from = context.ExCoinAccounts.Find(fromAccount.ID);
                var to = context.ExCoinAccounts.Find(toAccount.ID);
                if (from.ID != fromAccount.ID || to.ID != toAccount.ID) throw new Exception("User Not Found while Creating Transaction!");
                var t = new Transaction
                {
                    Amount = amount,
                    Description = description,
                    From = from,
                    To = to,
                    Status = "Pending",
                    Time = time
                };
                context.Transactions.Add(t);
                context.SaveChanges();
                return t;
            }
        }

        public Transaction CompleteTransaction(Transaction transaction)
        {
            using (var context = GetContext())
            using (var scope = context.Database.BeginTransaction())
            {
                try
                {
                    var t = context.Transactions.Find(transaction.ID);
                    var from = context.ExCoinAccounts.Find(transaction.From.ID);
                    var to = context.ExCoinAccounts.Find(transaction.To.ID);
                    if (t.ID != transaction.ID || from.ID != transaction.From.ID || to.ID != transaction.To.ID) throw new Exception("Value Not Found while Creating Transaction!");
                    t.Status = "Completed";
                    from.Balance -= t.Amount;
                    to.Balance += t.Amount;
                    context.SaveChanges();
                    scope.Commit();
                    return t;
                }
                catch
                {
                    scope.Rollback();
                    throw;
                }
            }
        }
    }
}
