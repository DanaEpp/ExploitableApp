version: '3.4'

services:
#  waf:
#    image: "owasp/modsecurity-crs:v3.1"
#    environment:
#      PROXY: "1"
#      UPSTREAM: "proxy:80"
#    ports:
#      - "80:80"
#    depends_on:
#      - proxy
  proxy:
    build:
      context: .
      dockerfile: ./haproxy/Dockerfile
    ports:
       - "80:80"
    depends_on:
      - app1
      - exploitableapp-ws
      - netmon
  app1:
    container_name: app1
    image: ${DOCKER_REGISTRY}exploitableapp
    build:
      context: .
      dockerfile: ./ExploitableApp/Dockerfile 
    depends_on:
      - db
      - exploitableapp-ws
      - redis
      - netmon
    ports:
      - "8080"
    volumes:
      - sharedfiles:/app/sharedfiles/
  exploitableapp-ws:
    image: ${DOCKER_REGISTRY}exploitableappwebservice
    build:
      context: .
      dockerfile: ./ExploitableApp.WebService/Dockerfile
    depends_on:
      - db
      - netmon
    volumes:
      - sharedfiles:/app/sharedfiles/
  redis:
    image: "redis:4.0.11"
    command: redis-server --requirepass Password1
    depends_on:
      - netmon
  db:
    image: "microsoft/mssql-server-linux"
    environment:
      SA_PASSWORD: "Password1"
      ACCEPT_EULA: "Y"
    depends_on:
      - netmon
  netmon:
    build:
      context: .
      dockerfile: ./ssh/Dockerfile
    ports:
      - "1337:22"

