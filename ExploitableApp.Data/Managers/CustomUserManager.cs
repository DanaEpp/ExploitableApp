using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Identity.EntityFrameworkCore;
using Microsoft.EntityFrameworkCore;
using ExploitableApp.Data.Models;
using Microsoft.AspNetCore.Identity;
using System.IO;
using ExploitableApp.Data.Services;
using ExploitableApp.Data.DataAccess;
using Microsoft.Extensions.Configuration;
using System.Net;

namespace ExploitableApp.Data.Managers
{
    public class CustomUserManager
    {
        public IConfiguration Configuration
        {
            get;
            private set;
        }

        public CustomUserManager(IConfiguration configuration)
        {
            Configuration = configuration;
        }

        private ApplicationDbContext GetContext()
        {
            //Configuration.GetConnectionString("DefaultConnection")
            var options = new DbContextOptionsBuilder<ApplicationDbContext>()
                .UseSqlServer(Configuration.GetConnectionString("DefaultConnection"))
                .EnableSensitiveDataLogging();
            return new ApplicationDbContext(options.Options);
        }

        public IEnumerable<string> GetEmailsLike(string email)
        {
            using (var context = GetContext())
            using (var connection = context.Database.GetDbConnection())
            {
                connection.Open();
                var cmd = connection.CreateCommand();
                cmd.CommandText = $"select email from aspnetusers where email like '{email}%'";
                using (var reader = cmd.ExecuteReader())
                {
                    if (!reader.HasRows)
                        yield break;

                    while (reader.Read())
                    {
                        yield return reader["email"].ToString();
                    }
                }
            }
        }
    }
}
